@model UsersManager.Models.Photo

@{
    ViewBag.Title = "Details";
}

<div id="PhotoDetailsContainer">
    <!-- Periodically refreshed -->
</div>

@section Scripts {
    @Scripts.Render("~/bundles/ratings")
    @Scripts.Render("~/bundles/partialRefresh")

    <script defer>
        ForceRefresh();
        installPartialRefresh("@Url.Action("GetPhotoDetails", new { photoId = (int)Model.Id })", "PhotoDetailsContainer", 5 /*secondes*/, PostRefreshTasks);
        function ForceRefresh() {
            let url = "@Url.Action("/")" + "GetPhotoDetails?forceRefresh=true&photoId=" + "@Model.Id";
            DoPartialRefresh(url, "PhotoDetailsContainer", PostRefreshTasks);
        }
        function PostRefreshTasks() {
            InstallRating();
            $("#currentUserRatingForm").hide();
            $("#commandSection").show();

            $("#AddModifyCurrentUserRating").click(function () {
                $("#currentUserRatingForm").show();
                $("#commandSection").hide();
                $("#PhotoRatingsContainer").scrollTop(0);
                PauseRefresh();
            });
            $("#updateCurrentUserRating").click(function () {
                let rating = $("input[name=ratingCurrentUser").val();
                let comment = $("#commentCurrentUser").val();
                let url = @Url.Action("/") + "UpdateCurrentUserRating?photoId=" + "@((int)Model.Id)" + "&rating=" + rating + "&comment=" + comment;
                ajaxActionCall(url, ForceRefresh);
                StartRefresh();
                $("#currentUserRatingForm").hide();
                $("#commandSection").show();
            })
            $("#cancelCurrentUserRating").click(function () {
                StartRefresh();
                $("#currentUserRatingForm").hide();
                $("#commandSection").show();
            })

            $(".sortRatings").click(function () {
                $(".sortRatings").css("color", "black");
                let url = @Url.Action("/") + "SortRatingsBy?fieldToSort=" + $(this).attr("fieldToSort");
                ajaxActionCall(url, ForceRefresh);
            });
        }

    </script>
}
